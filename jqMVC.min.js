/*!
 * jqMVC.js (C) 2015 Garrett R Morris, MIT license http://github.com/r3wt/jqMVC.git
 * @author Garrett R Morris (https://github.com/r3wt)
 * @package jqMVC.js
 * @license MIT
 * @version 0.3.0
 * router contains heavily modified code originally written by camilo tapia https://github.com/camme/jquery-router-plugin
 */
;!(function($,window,document){window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?':'+window.location.port:'')window.ctrl={}window.svc={}(function($){varv=$.fn.jquery.split('.'),n=[];for(vari=0;i<v.length;i++){n.push(parseInt(v[i]));}switch(true){case(n[0]<2):case(n[1]<1):case(n[2]<3):throw'jqMVCrequiresjQuery2.1.3orgreater.Upgradedummy!';break;}}($))$.fn.serializeObject=function(){varb=this.serializeArray();vara={};for(vari=0;i<b.length;i++){a[b[i].name]=b[i].value;}returna;}varnotify={alert:function(message){alert(message);},confirm:function(message,callback){if(confirm(message)){callback.apply(this);}}}varprogress={start:function(){},stop:function(){}}varview={render:function(){app.done();throw'Youmustimplementaviewwith`setView()`beforeyoucanrendertemplates';}}varmodel={}functionisDefined(t){returntypeoft!=='undefined';}functionisString(t){returntypeoft==='string';}functionisWindow(t){returnt&&t.document&&t.location&&t.alert&&t.setInterval;}functionisDocument(t){returnwindow.document===t;}functionisApp(t){returnt===app;}functionsetter(obj,prop,ret){if(!obj.hasOwnProperty(prop)){obj[prop]={};}returnfunction(name,mixedvar){obj[prop][name]=mixedvar;returnret;};}functiongetPath(){varpath=app_path.replace(window.location.origin,'').replace(/\/+/g,'/').trim('/');if(path.length===0){path+='/';}returnpath;}functioncheckRoutes(){varcurrentUrl=parseUrl(location.pathname)varactionList=getParameters(currentUrl);if(actionList.length===0){emit('notFound');}else{for(vari=0;i<actionList.length;i++){varroute=actionList[i];varargs=[];for(varpropinactionList[i].data){args.push(actionList[i].data[prop]);}if(typeofroute.callback!=='function'&&route.callback.isArray()){for(varj=0;j<route.callback.length;j++){if(j==route.callback.length-1){route.callback[j].apply(this,args);}else{varresult=route.callback[j].apply(this);if(typeofresult!=="undefined"){break;}}}}else{route.callback.apply(this,args);}}}};functionparseUrl(url){varcurrentUrl=url?url:location.pathname;currentUrl=decodeURI(currentUrl)if(!hasPushState){if(location.hash.indexOf("#!/")===0){currentUrl+=location.hash.substring(3);}else{return'';}}if(currentUrl.slice(-1)=='/'){currentUrl=currentUrl.substring(0,currentUrl.length-1);}returncurrentUrl;};functiongetParameters(url){vardataList=[];for(vari=0;i<routeList.length;i++){varroute=routeList[i];if(route.type=="regexp"){varresult=url.match(route.route);if(result){varobj=(function(){returnroute;}());obj.data={matches:result};dataList.push(obj)break;}}else{varcurrentUrlParts=url.split("/");varrouteParts=route.route.split("/");if(routeParts.length==currentUrlParts.length){vardata={};varmatched=true;varmatchCounter=0;for(varj=0;j<routeParts.length;j++){if(routeParts[j].indexOf(":")===0){data[routeParts[j].substring(1)]=decodeURI(currentUrlParts[j]);matchCounter++;}else{if(routeParts[j]==currentUrlParts[j]){matchCounter++;}}}if(routeParts.length==matchCounter){varobj=(function(){returnroute;}());obj.data=data;dataList.push(obj);router.currentParameters=data;break;}}}}returndataList;};functionhandleRoutes(e){if(e!=null&&e.originalEvent&&e.originalEvent.state!==undefined){checkRoutes();}elseif(hasHashState){checkRoutes();}elseif(!hasHashState&&!hasPushState){checkRoutes();}};functiondebugmsg(msg){if(debug){window.console&&console.log('$.jqMVC::'+msg);}};functionemit(event,eventData){debugmsg('emit->`'+event+'`');$(app).trigger(event,eventData);}varjQselector=$.fn.init,jQbound=[],evt={};$.fn.init=function(selector){vartrackSelector=isDefined(selector)&&!isApp(selector)&&((isString(selector)||isWindow(selector)||isDocument(selector))!==false);varjQinstance=newjQselector(selector,window.document,$)if(trackSelector){jQbound=app.merge(jQbound,[selector]);}returnjQinstance;};evt.bindRouter=function(){eventAdded=true;router.fromHash=false;if(hasPushState){if(location.hash.indexOf("#!/")===0){varurl=location.pathname+location.hash.replace(/^#!\//gi,"");history.replaceState({},"",url);router.fromHash=true;}$(window).bind("popstate",handleRoutes);}elseif(hasHashState){$(window).bind("hashchange.router",handleRoutes);}else{router.interval=setInterval(function(){if(location.href!=currentUsedUrl){handleRoutes();currentUsedUrl=location.href;}},500);}};evt.bindHref=function(){$(document).on('click','a[data-href]',function(e){e.preventDefault();emit('before.go');app.go(getPath().replace(/\/+$/,'')+$(this).data('href'),'Loading');returnfalse;});};evt.bindForm=function(){$(document).on('submit','form[ctrl][action][callback]',function(event){event.preventDefault();var_this=$(this),before_function=_this.attr('before'),callback_function=_this.attr('callback'),endpoint=api_path+_this.attr('action'),controller=window.ctrl[_this.attr('ctrl')],query_string=_this.serializeObject();console.log(query_string);$.jqMVC.before();_this.find('button[type="submit"]').prop('disabled',true);if(typeofbefore_function!=="undefined"&&before_function!==false){varbefore_error=controller[before_function].call(_this);if(before_error!==false){$.jqMVC.alert(before_error,'error');return;}}if(typeofcallback_function==="undefined"||callback_function===false){$.jqMVC.alert('FORMDOESNOTSPECIFYCALLBACK.UNABLETOCONTINUE.','error');return;}$.post(endpoint,query_string,function(data){vardata=JSON.parse(data);controller[callback_function].call(_this,data);}).fail(function(jqXHR,textStatus,errorThrown){controller[callback_function].call(_this,{'error':1,'message':'AnUnknownErrorOccured:'+jqXHR.status+''+jqXHR.responseText});}).always(function(){$.jqMVC.done();_this.find('button[type="submit"]').prop('disabled',false);});returnfalse;});};functionunbindEvents(){for(vari=0;i<jQbound.length;i++){$(jQbound[i]).find("*").addBack().off();}jQbound.length=0;clearInterval(router.interval);}functionbindEvents(){for(varcinevt){evt[c].apply(this);}}varstack={};stack.items=[];stack.next=function(){stack.items.shift().call($,stack);}varhasPushState=(history&&history.pushState);varhasHashState=!hasPushState&&("onhashchange"inwindow)&&false;varrouteList=[];vareventAdded=false;varcurrentUsedUrl=location.href;varfirstRoute=true;varfirstRun=false;varrouter={};router.interval=null;router.currentId="";router.currentParameters={};router.capabilities={hash:hasHashState,pushState:hasPushState,timer:!hasHashState&&!hasPushState};router.checkRoute=function(url){returngetParameters(parseUrl(url)).length>0;}router.parameters=function(url){varcurrentUrl=parseUrl(url)varlist=getParameters(currentUrl)if(list.length==0){router.currentParameters={};}else{router.currentParameters=list[0].data;}returnrouter.currentParameters;}varapp={};app.add=function(callable){stack.items.push(callable);returnapp;};app.addBinding=function(name,callback){if(binding_override||!evt.hasOwnProperty(name)){evt[name]=callback;}returnapp;};app.addSvc=function(name,mixedvar,retval){window.svc[name]=mixedvar;returnapp;};app.alert=function(){notify.alert.apply(this,arguments);returnapp;};app.before=function(){progress.start();returnapp;};app.confirm=function(){notify.confirm.apply(this,arguments);returnapp;};app.ctrl=function(name,object){window.ctrl[name]=object;returnapp;};app.data=function(args){for(varpropinargs){window[prop]=args[prop];}returnapp;};app.done=function(){emit('on.done');progress.stop();unbindEvents();bindEvents();returnapp;};app.go=function(url){if(hasPushState){history.pushState({},null,url);checkRoutes();if(!eventAdded){evt.bindRouter();}}else{if(!eventAdded){evt.bindRouter();}url=url.replace(location.protocol+"//","").replace(location.hostname,"");varhash=url.replace(location.pathname,"");if(hash.indexOf("!")<0){hash="!/"+hash;}location.hash=hash;}returnapp;};app.listen=function(event,callback){$(app).bind(event,callback);returnapp;};app.listenOnce=function(event,callback){$(app).one(event,callback);returnapp;};app.merge=function(){varargs=[],result=[],unique=function(a,b){vara=a.concat(b);for(vari=0;i<a.length;++i){for(varj=i+1;j<a.length;++j){if(a[i]===a[j])a.splice(j--,1);}}returna;};Array.prototype.push.apply(args,arguments);for(k=0;k<args.length;k++){result=unique(result,args[k]);}returnresult;};app.path=function(){varargs=[];Array.prototype.push.apply(args,arguments);varroute=args.shift()varcallback=args.pop()varmiddleware=argsroute=getPath().replace(/\/+$/,'')+route;varisRegExp=typeofroute=="object";if(!isRegExp){if(route.lastIndexOf("/")==route.length-1){route=route.substring(0,route.length-1);}route=route.replace(location.protocol+"//","").replace(location.hostname,"");}varobj={};if(middleware.length>0){obj.callback=middleware;obj.callback.push(callback);}routeList.push({route:route,callback:callback,type:isRegExp?"regexp":"string",});returnapp;};app.render=function(){view.render.apply(this,arguments);returnapp;};app.run=function(){if(!firstRun){emit('firstRun');firstRun=true;app.add(function(){app.go(location.href);});stack.next();}app.run=function(){};returnapp;};app.setNotifications=function(obj){notify=obj;returnapp;};app.setProgress=function(obj){progress=obj;returnapp;};app.setView=function(obj){view=obj;returnapp;};app.trigger=function(event,eventData){emit(event,eventData);returnapp;}app.data({app_path:window.location.origin,api_path:'',view_path:'/',element:$('body'),debug:false,binding_override:false,});$.jqMVC=app;}(jQuery,window,document));